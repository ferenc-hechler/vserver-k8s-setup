apiVersion: batch/v1
kind: Job
metadata:
  name: minecraft-restore-job
  namespace: minecraft
  labels:
    app: minecraft-restore
spec:
      template:
        spec:
          containers:
          - name: minecraft-restore
            image: feridock/pgpcloudbackup:0.1
            command: [ "/bin/sh", "-c", "--" ]
            args: [ "echo waiting 10h;
            sleep 36000;
            echo finished"]
            securityContext:
              runAsUser: 0
              runAsGroup: 0            
            imagePullPolicy: IfNotPresent
            #imagePullPolicy: Always
            env:
            - name: PGPCB_CONFIG_FILE
              value: "/app/conf/.pcloud-config"
            - name: PGPCB_PRIVATE_PGP_KEY_FILE
              value: "/app/conf/.private-decrypt.key"
            - name: PGPCB_ENC_KEY_PASSPHRASE
              valueFrom:
                secretKeyRef:
                  name: minecraft-restore-secret
                  key: enc-passphrase
            - name: PGPCB_LOCAL_FOLDER
              value: "/restore"
            - name: PGPCB_REMOTE_FOLDER
              value: "/VSERVERBACKUP/minecraft"
            - name: PGPCB_DELETE_LOCAL
              value: "true"
            - name: PGPCB_TEMP_FOLDER
              value: "/tmp"
            volumeMounts:
            - mountPath: /restore
              name: restore
            - name: config
              mountPath: "/app/conf"
              readOnly: true
            - mountPath: /minecraft-data
              name: minecraft-data
          volumes:
          - name: restore
            persistentVolumeClaim:
              claimName: minecraft-backup-pvc
          - name: config
            secret:
              secretName: minecraft-restore-secret
          - name: minecraft-data
            persistentVolumeClaim:
              claimName: minecraft-pvc
          restartPolicy: Never
      backoffLimit: 3
